<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://unpkg.com/prunecluster@2.1.0/dist/LeafletStyleSheet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_01320fec45bb1e5f89f581491177f6ba {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
    <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.css"/>
</head>
<body>
    
    
    <style>
    /* Popup Container */
    .leaflet-popup-content-wrapper {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 8px;
        padding: 0;
        border: 1px solid #ddd;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .leaflet-popup-content {
        margin: 15px !important;
        width: 280px !important;
    }
    .leaflet-popup-tip {
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid #ddd;
    }
    
    /* Content Styles */
    .popup-header {
        font-size: 14px;
        font-weight: bold;
        color: #555;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .popup-row {
        margin-bottom: 5px;
        font-size: 13px;
        line-height: 1.4;
    }
    .popup-label {
        color: #666;
        margin-right: 5px;
    }
    .popup-value {
        color: #000;
        font-weight: 500;
    }
    .popup-value.margin {
        color: #00a86b;
        font-weight: bold;
    }
    .popup-value.type {
        color: #0088cc;
    }
    .popup-address {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-size: 11px;
        color: #777;
        font-style: italic;
    }
    </style>
    
    
    <script>
        console.log("Script injected. Waiting for window load...");
        window.addEventListener("load", function() {
            
            // Wait for Leaflet to be ready
            if (typeof L === 'undefined') {
                console.error("Leaflet (L) is undefined even after window load!");
                return;
            }
            
            startApp();
            
            function startApp() {
                var mapId = "map_01320fec45bb1e5f89f581491177f6ba";
                
                console.log("Looking for map: " + mapId);

                function initMapLogic(mapInstance) {
                    console.log("Initializing map logic on:", mapInstance);
                    
                    // Layer group to hold our markers
                    var markerLayer = L.layerGroup().addTo(mapInstance);
                    
                    var typeMap = {'M': 'Maison', 'A': 'Appartement', 'L': 'Local', 'X': 'Autre'};

                    function createTooltipContent(props) {
                        // props matches the structure: [lat, lon, type_code, margin, address]
                        // OR directly from the API object if we adjust it.
                        // The original code expected props array from PruneCluster data.obj
                        // Let's adapt to take the direct property object.
                        
                        var typeCode = props.type_local ? props.type_local.charAt(0) : 'X';
                        var typeStr = typeMap[typeCode] || 'Autre';
                        var marginVal = props.margin || 0;
                        var marginStr = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(marginVal);
                        var address = props.address || '';
                        
                        return '<div class="popup-header">DÃ©tail du flip</div>' +
                            '<div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value type">' + typeStr + '</span></div>' +
                            '<div class="popup-row"><span class="popup-label">Marge:</span><span class="popup-value margin">' + marginStr + '</span></div>' +
                            '<div class="popup-address">' + address + '</div>';
                    }

                    // Dynamic loading logic
                    function loadMarkers() {
                        if (!mapInstance) return;
                        
                        const bounds = mapInstance.getBounds();
                        const zoom = mapInstance.getZoom();
                        
                        console.log("Loading markers for bounds:", bounds.toBBoxString(), "Zoom:", zoom);

                        fetch(`/api/markers?` + new URLSearchParams({
                            min_lat: bounds.getSouth(),
                            max_lat: bounds.getNorth(),
                            min_lon: bounds.getWest(),
                            max_lon: bounds.getEast(),
                            zoom: zoom
                        }))
                        .then(r => r.json())
                        .then(data => {
                            console.log(`Fetched ${data.length} markers/items.`);
                            markerLayer.clearLayers();
                            
                            data.forEach(item => {
                                if (item.latitude === undefined || item.longitude === undefined) return;

                                // Check if it's a cluster
                                if (item.count !== undefined && item.count > 1) {
                                    // Render as cluster
                                    var sizeClass = 'prunecluster-small';
                                    if (item.count >= 100) sizeClass = 'prunecluster-large';
                                    else if (item.count >= 10) sizeClass = 'prunecluster-medium';
                                    
                                    var icon = L.divIcon({
                                        html: "<div><span>" + item.count + "</span></div>",
                                        className: "prunecluster " + sizeClass,
                                        iconSize: [44, 44] // Approximate size for PruneCluster icons
                                    });
                                    
                                    var marker = L.marker([item.latitude, item.longitude], { icon: icon });
                                    
                                    // Zoom on click for clusters
                                    marker.on('click', function() {
                                        mapInstance.setView([item.latitude, item.longitude], zoom + 2);
                                    });
                                    
                                    markerLayer.addLayer(marker);
                                } else {
                                    // Render as single property
                                    var marker = L.marker([item.latitude, item.longitude]);
                                    
                                    var tooltipContent = createTooltipContent(item);
                                    
                                    marker.bindTooltip(tooltipContent, {
                                        sticky: true, 
                                        direction: 'top',
                                        className: 'custom-tooltip' 
                                    });
                                    
                                    markerLayer.addLayer(marker);
                                }
                            });
                        })
                        .catch(err => console.error("Error loading markers:", err));
                    }

                    mapInstance.on('moveend', loadMarkers);
                    mapInstance.on('zoomend', loadMarkers);
                    
                    // Initial load
                    loadMarkers();
                }

                // Poll for map instance
                var attempts = 0;
                var interval = setInterval(function() {
                    attempts++;
                    var mapInstance = window[mapId];
                    
                    // Fallback: Find any Leaflet map on page
                    if (!mapInstance) {
                        for (var k in window) {
                            if (k.startsWith('map_') && window[k] && window[k].addLayer) {
                                mapInstance = window[k];
                                console.log("Found map via fallback key:", k);
                                break;
                            }
                        }
                    }

                    if (mapInstance) {
                        clearInterval(interval);
                        initMapLogic(mapInstance);
                    } else if (attempts > 50) { // 10 seconds
                        console.error("Could not find Leaflet map instance.");
                        clearInterval(interval);
                    }
                }, 200);
            }

        });
    </script>
    
    
            <div class="folium-map" id="map_01320fec45bb1e5f89f581491177f6ba" ></div>
        
</body>
<script>
    
    
            var map_01320fec45bb1e5f89f581491177f6ba = L.map(
                "map_01320fec45bb1e5f89f581491177f6ba",
                {
                    center: [46.603354, 1.888334],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 6,
  "zoomControl": true,
  "preferCanvas": true,
}

                }
            );

            

        
    
            var tile_layer_8a54bb85a30f94c70a9c5fbb2943fd3b = L.tileLayer(
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 19,
  "maxNativeZoom": 19,
  "noWrap": false,
  "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_8a54bb85a30f94c70a9c5fbb2943fd3b.addTo(map_01320fec45bb1e5f89f581491177f6ba);
        
    
            L.control.fullscreen(
                {
  "position": "topleft",
  "title": "Full Screen",
  "titleCancel": "Exit Full Screen",
  "forceSeparateButton": false,
}
            ).addTo(map_01320fec45bb1e5f89f581491177f6ba);
        
</script>
</html>